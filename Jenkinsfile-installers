@Library("titan-library") _ 

pipeline {
    agent {
        label 'master'
    }
    triggers {
        //cron(cron_string)
        gitlab(triggerOnPush: true, triggerOnMergeRequest: true, branchFilterType: 'All')
    }
    options {
        // Set this to true if you want to clean workspace during the prep stage
        skipDefaultCheckout(true)

        // Console debug options
        timestamps()
        ansiColor('xterm')

        gitLabConnection('gitlab-installer-connection')
    }

    stages {
        stage("Get POM Version") {
            steps {
                // Clean before checkout / build
                cleanWs()
                checkout scm

                // Get the release information
                script {
                    pomModel = readMavenPom(file: 'pom.xml')
                    pomVersion = pomModel.getVersion()
                    isSnapshot = pomVersion.contains("-SNAPSHOT")
                    pomGroupId = pomModel.groupId

                    repositoryId = 'maven-releases'
                    RELEASE_VERSION=pomVersion
                    RELEASE_MSG="release ${RELEASE_VERSION}"

                    echo "pomVersion: ${pomVersion}"
                    echo "isSnapshot: ${isSnapshot}"
                    echo "pomGroupId: ${pomGroupId}"
                }
            }
        }

        stage("Build Installers for Multiple OS and Publish to Nexus Repository Manager") {
            when{
                expression{
                    !isSnapshot //&& env.BRANCH_NAME == 'main'
                }
            }
            parallel {
                stage("Publish Linux Installer to Nexus Repository Manager") {
                    agent {
                        label 'linux'
                    }
                    tools {
                        jdk 'default'
                        maven 'default'
                    }
                    steps {
                        // Clean before checkout / build
                        cleanWs()
                        checkout scm

                        //Pull Sample data for Installer Generation
                        sh """
                            rm -rf ${env.WORKSPACE}/application/installer_resources/sample_data
                            mkdir ${env.WORKSPACE}/application/installer_resources/sample_data
                            curl -SL \
                                "https://nexus.build.tinkarbuild.com/repository/maven-releases/dev/ikm/komet/Sample_Data/2.0/Sample_Data-2.0.zip" \
                                --output ${env.WORKSPACE}/application/installer_resources/sample_data/sample_data.zip \
                        """

                        configFileProvider([configFile(fileId: 'settings.xml', variable: 'MAVEN_SETTINGS')]) {
                            //Build Komet and create installer
                            sh """
                                mvn --version
                                mvn clean install \
                                    -s ${MAVEN_SETTINGS} \
                                    -P create-installer \
                                    --batch-mode \
                                    -e \
                                    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
                            """

                            //Deploy Komet Installer to Nexus
                            sh """
                                mvn deploy:deploy-file \
                                    --batch-mode \
                                    -e \
                                    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
                                    -s ${MAVEN_SETTINGS} \
                                    -Dfile=\$(find application/target/dist/installer/ -name komet-${pomVersion}*.rpm) \
                                    -Durl=https://nexus.build.tinkarbuild.com/repository/maven-releases/ \
                                    -DgroupId=${pomGroupId} \
                                    -DartifactId=komet-installer-linux \
                                    -Dversion=${pomVersion} \
                                    -Dclassifier=unsigned \
                                    -Dtype=pkg \
                                    -Dpackaging=pkg \
                                    -DrepositoryId=titan-maven-releases
                            """
                        }
                    }
                }
                stage("Publish Mac M1 Installer to Nexus Repository Manager") {
                    agent {
                        label 'mac_m1'
                    }
                    tools {
                        jdk 'default'
                        maven 'default'
                    }
                    steps {
                        // Clean before checkout / build
                        cleanWs()
                        checkout scm

                        //Pull Sample data for Installer Generation
                        sh """
                            rm -rf ${env.WORKSPACE}/application/installer_resources/sample_data
                            mkdir ${env.WORKSPACE}/application/installer_resources/sample_data
                            curl -SL \
                                "https://nexus.build.tinkarbuild.com/repository/maven-releases/dev/ikm/komet/Sample_Data/2.0/Sample_Data-2.0.zip" \
                                --output ${env.WORKSPACE}/application/installer_resources/sample_data/sample_data.zip \
                        """

                        configFileProvider([configFile(fileId: 'settings.xml', variable: 'MAVEN_SETTINGS')]) {
                            //Build Komet and create installer
                            sh """
                                mvn --version
                                mvn clean install \
                                    -s ${MAVEN_SETTINGS} \
                                    -P create-installer \
                                    --batch-mode \
                                    -e \
                                    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
                            """

                            //Deploy Komet Installer to Nexus
                            sh """
                                mvn deploy:deploy-file \
                                    --batch-mode \
                                    -e \
                                    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
                                    -s ${MAVEN_SETTINGS} \
                                    -Dfile=\$(find application/target/dist/installer/ -name Komet-${pomVersion}*.pkg) \
                                    -Durl=https://nexus.build.tinkarbuild.com/repository/maven-releases/ \
                                    -DgroupId=${pomGroupId} \
                                    -DartifactId=komet-installer-macm1 \
                                    -Dversion=${pomVersion} \
                                    -Dclassifier=unsigned \
                                    -Dtype=pkg \
                                    -Dpackaging=pkg \
                                    -DrepositoryId=titan-maven-releases
                            """
                        }
                    }
                }
                stage("Publish Mac Intel Installer to Nexus Repository Manager") {
                    agent {
                        label 'mac_intel'
                    }
                    tools {
                        jdk 'default'
                        maven 'default'
                    }
                    steps {
                        // Clean before checkout / build
                        cleanWs()
                        checkout scm

                        //Pull Sample data for Installer Generation
                        sh """
                            rm -rf ${env.WORKSPACE}/application/installer_resources/sample_data
                            mkdir ${env.WORKSPACE}/application/installer_resources/sample_data
                            curl -SL \
                                "https://nexus.build.tinkarbuild.com/repository/maven-releases/dev/ikm/komet/Sample_Data/2.0/Sample_Data-2.0.zip" \
                                --output ${env.WORKSPACE}/application/installer_resources/sample_data/sample_data.zip \
                        """

                        configFileProvider([configFile(fileId: 'settings.xml', variable: 'MAVEN_SETTINGS')]) {
                            //Build Komet and create installer
                            sh """
                            mvn --version
                            mvn clean install \
                                -s ${MAVEN_SETTINGS} \
                                -P create-installer \
                                --batch-mode \
                                -e \
                                -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
                            """

                            //Deploy Komet Installer to Nexus
                            sh """
                                mvn deploy:deploy-file \
                                    --batch-mode \
                                    -e \
                                    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
                                    -s ${MAVEN_SETTINGS} \
                                    -Dfile=\$(find application/target/dist/installer/ -name Komet-${pomVersion}*.pkg) \
                                    -Durl=https://nexus.build.tinkarbuild.com/repository/maven-releases/ \
                                    -DgroupId=${pomGroupId} \
                                    -DartifactId=komet-installer-macintel \
                                    -Dversion=${pomVersion} \
                                    -Dclassifier=unsigned \
                                    -Dtype=pkg \
                                    -Dpackaging=pkg \
                                    -DrepositoryId=titan-maven-releases
                            """
                        }
                    }
                }
                stage("Publish Windows Installer to Nexus Repository Manager") {
                    agent {
                        label 'windows'
                    }
                    tools {
                        jdk 'default'
                        maven 'default'
                        //wix added to path using jenkins agent environment variables
                    }
                    steps {
                        // Clean before checkout / build
                        cleanWs()
                        checkout scm

                        //Pull Sample data for Installer Generation
                        bat """
                            if exist ${env.WORKSPACE}\\application\\installer_resources\\sample_data rmdir /s /q ${env.WORKSPACE}\\application\\installer_resources\\sample_data
                            mkdir ${env.WORKSPACE}\\application\\installer_resources\\sample_data
                            curl -SL \
                                "https://nexus.build.tinkarbuild.com/repository/maven-releases/dev/ikm/komet/Sample_Data/2.0/Sample_Data-2.0.zip" \
                                --output ${env.WORKSPACE}\\application\\installer_resources\\sample_data\\sample_data.zip
                        """

                        configFileProvider([configFile(fileId: 'settings.xml', variable: 'MAVEN_SETTINGS')]) {
                            //Build Komet and create installer
                            bat """
                                mvn --version && \
                                mvn clean install \
                                    -s ${MAVEN_SETTINGS} \
                                    -P create-installer \
                                    --batch-mode \
                                    -e \
                                    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn
                            """
                            
                            //Deploy Komet Installer to Nexus
                            bat """
                                setx JAVA_HOME "${JAVA_HOME}"
                                set PATH=${JAVA_HOME}\\bin'${M2_HOME}\\bin;${WIX_HOME}\\bin;%PATH%
                                mvn deploy:deploy-file \
                                    --batch-mode \
                                    -e \
                                    -Dorg.slf4j.simpleLogger.log.org.apache.maven.cli.transfer.Slf4jMavenTransferListener=warn \
                                    -s ${MAVEN_SETTINGS} \
                                    -Dfile=application\\target\\dist\\installer\\Komet-${pomVersion}.msi \
                                    -Durl=https://nexus.build.tinkarbuild.com/repository/maven-releases/ \
                                    -DgroupId=${pomGroupId} \
                                    -DartifactId=komet-installer-windows \
                                    -Dversion=${pomVersion} \
                                    -Dclassifier=unsigned \
                                    -Dtype=msi \
                                    -Dpackaging=msi \
                                    -DrepositoryId=titan-maven-releases
                            """
                        }
                    }
                }
            }
        }
    }


    post {
        failure {
            updateGitlabCommitStatus name: 'build', state: 'failed'
        }
        success {
            updateGitlabCommitStatus name: 'build', state: 'success'
        }
        aborted {
            updateGitlabCommitStatus name: 'build', state: 'canceled'
        }
        always {
            // Clean the workspace after build
            cleanWs(cleanWhenNotBuilt: false,
                deleteDirs: true,
                disableDeferredWipeout: true,
                notFailBuild: true,
                patterns: [
                [pattern: '.gitignore', type: 'INCLUDE']
            ])
        }
    }
}
